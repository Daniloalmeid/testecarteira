<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Phantom Callback</title>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl@1.0.3/nacl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tweetnacl-util@0.15.1/nacl-util.min.js"></script>
</head>
<body>
  <h2>Carteira conectada!</h2>
  <p id="result">Processando...</p>

  <script>
    function getParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function decryptData() {
      try {
        const encryptedPayload = getParam("phantom_encrypted_payload");
        const nonce = getParam("phantom_nonce");
        const encryptionPublicKey = getParam("phantom_encryption_public_key");
        const dappPrivateKeyBase64 = getParam("dapp_private_key");

        if (!dappPrivateKeyBase64) {
          document.getElementById("result").innerText = "Chave dApp ausente. Não é possível descriptografar.";
          return;
        }

        const dappPrivateKey = nacl.util.decodeBase64(dappPrivateKeyBase64);
        const phantomPublicKey = nacl.util.decodeBase64(encryptionPublicKey);

        const payload = nacl.box.open(
          nacl.util.decodeBase64(encryptedPayload),
          nacl.util.decodeBase64(nonce),
          phantomPublicKey,
          dappPrivateKey
        );

        if (!payload) {
          document.getElementById("result").innerText = "Falha ao descriptografar.";
          return;
        }

        const payloadStr = nacl.util.encodeUTF8(payload);
        const payloadObj = JSON.parse(payloadStr);
        const publicKey = payloadObj.public_key;

        document.getElementById("result").innerText = "Carteira conectada: " + publicKey;
      } catch (err) {
        console.error(err);
        document.getElementById("result").innerText = "Erro ao processar os dados.";
      }
    }

    decryptData();
  </script>
</body>
</html>
